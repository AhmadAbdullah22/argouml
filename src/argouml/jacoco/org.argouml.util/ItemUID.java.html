<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ItemUID.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">argouml-app</a> &gt; <a href="index.source.html" class="el_package">org.argouml.util</a> &gt; <span class="el_source">ItemUID.java</span></div><h1>ItemUID.java</h1><pre class="source lang-java linenums">/* $Id$
 *****************************************************************************
 * Copyright (c) 2009-2012 Contributors - see below
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    bobtarling
 *****************************************************************************
 *
 * Some portions of this file was previously release using the BSD License:
 */

// Copyright (c) 2002-2008 The Regents of the University of California. All
// Rights Reserved. Permission to use, copy, modify, and distribute this
// software and its documentation without fee, and without a written
// agreement is hereby granted, provided that the above copyright notice
// and this paragraph appear in all copies.  This software program and
// documentation are copyrighted by The Regents of the University of
// California. The software program and documentation are supplied &quot;AS
// IS&quot;, without any accompanying services from The Regents. The Regents
// does not warrant that the operation of the program will be
// uninterrupted or error-free. The end-user understands that the program
// was developed for research purposes and is advised not to rely
// exclusively on the program for any reason.  IN NO EVENT SHALL THE
// UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
// SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS,
// ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF
// THE UNIVERSITY OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF
// SUCH DAMAGE. THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
// MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE
// PROVIDED HEREUNDER IS ON AN &quot;AS IS&quot; BASIS, AND THE UNIVERSITY OF
// CALIFORNIA HAS NO OBLIGATIONS TO PROVIDE MAINTENANCE, SUPPORT,
// UPDATES, ENHANCEMENTS, OR MODIFICATIONS.

package org.argouml.util;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.argouml.model.Model;

/**
 * An instance of this class is supposed to be attached to an instance
 * of another class to uniquely identify it. It is intended that such
 * a tagging should be persistent over saving and loading, if applicable.&lt;p&gt;
 *
 * The class also harbors the
 * {@link #getIDOfObject getIDOfObject(Object, boolean)} which provides
 * a way to get the ItemUID of any object with a method
 * &lt;code&gt;ItemUID getItemUID()&lt;/code&gt;
 * and creating new ItemUIDs for any object with a method
 * &lt;code&gt;setItemUID(ItemUID)&lt;/code&gt;
 * using reflection in java.&lt;p&gt;
 *
 * A class intended to be tagged must at least provide a
 * &lt;code&gt;ItemUID getItemUID()&lt;/code&gt;
 * method. It may also provide a
 * &lt;code&gt;void setItemUID(ItemUID id)&lt;/code&gt;
 * such that getItemUID() will return id if a call returns successfully,
 * and which is stored persistently should the tagged object be stored.
 * This allows this class to automatically tag an object when necessary,
 * but it is allowed to tag classes by other means and only provide the
 * getItemUID() call.&lt;p&gt;
 *
 * A critical requirement for this class is that the cognitive component
 * is supposed to work with general objects. This class is a wrapper around
 * places where the component needs persistent identities of objects, since
 * I have said that some features cannot be implemented without that, such as
 * ResolvedCritic, and so far noone has shown me wrong (though I wouldn't
 * mind). It is for this reason that some perhaps ugly looking exceptions in
 * this code must be considered perfectly normal conditions. Failure of some
 * object to work with tagging must be handled by the cognitive component
 * programmer and it is (see eg ResolvedCritic).&lt;p&gt;
 *
 * A possible future change would be to allow tag handlers to be registered
 * with this class to handle other preexisting tagging mechanisms, which
 * could be used to remove the dependancy to the model component here, which
 * I find a bit unaesthetic. So far, not enough to write it (though it is not
 * much work).
 *
 * @author Michael Stockman
 */
public class ItemUID {
    /**
     * The logger.
     */
<span class="fc" id="L93">    private static final Logger LOG = Logger.getLogger(ItemUID.class.getName());</span>

    /**
     * Keeps a reference to the Class object of this class.
     */
<span class="fc" id="L98">    private static final Class MYCLASS = (new ItemUID()).getClass();</span>

    /**
     * This actual ID of this instance.
     */
    private String id;

    /**
     * Constructs a new ItemUID and creates a new ID for it.
     */
<span class="fc" id="L108">    public ItemUID() {</span>
<span class="fc" id="L109">	id = generateID();</span>
<span class="fc" id="L110">    }</span>

    /**
     * Constructs a new ItemUID and uses the String param as the ID.
     * Mainly intended to be used during loading of saved objects.
     *
     * @param	param	The ID to used for the new instance.
     * @see		#toString()
     */
<span class="fc" id="L119">    public ItemUID(String param) {</span>
<span class="fc" id="L120">	id = param;</span>
<span class="fc" id="L121">    }</span>

    /**
     * Returns the ID of this ItemUID as a String. If everything works all
     * such Strings will be unique. It is possible to created a new
     * identical ItemUID using this String.
     *
     * @return	The ID as a String.
     * @see		#ItemUID(String)
     */
    public String toString() {
<span class="fc" id="L132">	return id;</span>
    }

    /**
     * Generates a new unique ID and returns it as a String. The contents
     * of the String is supposed to be unique with respect to all Strings
     * generated by other instances of this class.
     * TODO: We should consider using java.util.UUID for this instead.
     *
     * @return	A String with unique content.
     */
    public static String generateID() {
<span class="fc" id="L144">	return (new java.rmi.server.UID()).toString();</span>
    }

    /**
     * Obtains the ID of an object and returns it as a String. If
     * canCreate is true it will try to create a new ID for the object
     * if it has none.
     *
     * @param obj the Object to get the ID of.
     * @param canCreate If an ID can be created, should object not have one.
     * @return	The ID of the object, or null.
     */
    public static String getIDOfObject(Object obj, boolean canCreate) {
<span class="fc" id="L157">	String s = readObjectID(obj);</span>

<span class="pc bpc" id="L159" title="1 of 4 branches missed.">	if (s == null &amp;&amp; canCreate) {</span>
<span class="fc" id="L160">	    s = createObjectID(obj);</span>
	}

<span class="fc" id="L163">	return s;</span>
    }

    /**
     * Tries to read the ID of the object. It uses the reflective
     * properties of java to access a method named getItemUID of the
     * object which is expected to return an ItemUID.
     *
     * @param obj The object whose ID to read.
     * @return	The ID of the object, or null.
     */
    protected static String readObjectID(Object obj) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (Model.getFacade().isAUMLElement(obj)) {</span>
<span class="fc" id="L176">            return Model.getFacade().getUUID(obj);</span>
        }

<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (obj instanceof IItemUID) {</span>
<span class="fc" id="L180">            final ItemUID itemUid = ((IItemUID) obj).getItemUID();</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            return (itemUid == null ? null : itemUid.toString());</span>
        }
	Object rv;
	try {
	    // TODO: We shouldn't need this reflection any more once we have
	    // convinced ourselves that everything with a getItemUID method
	    // is implementing IItemUID
<span class="nc" id="L188">	    Method m = obj.getClass().getMethod(&quot;getItemUID&quot;, (Class[]) null);</span>
<span class="nc" id="L189">	    rv = m.invoke(obj, (Object[]) null);</span>
<span class="fc" id="L190">	} catch (NoSuchMethodException nsme) {</span>
	    // Apparently this object had no getItemUID
	    try {
                // This is needed for a CommentEdge ...
                // TODO: Why doesn't CommentEdge implement IItemUID and be
	        // handled with the mechanism above.
<span class="fc" id="L196">	        Method m = obj.getClass().getMethod(&quot;getUUID&quot;, (Class[]) null);</span>
<span class="fc" id="L197">	        rv = m.invoke(obj, (Object[]) null);</span>
<span class="fc" id="L198">                return (String) rv;</span>
<span class="nc" id="L199">	    } catch (NoSuchMethodException nsme2) {</span>
	        // Apparently this object had no getUUID
<span class="nc" id="L201">	        return null;</span>
<span class="nc" id="L202">	    } catch (IllegalArgumentException iare) {</span>
<span class="nc" id="L203">                LOG.log(Level.SEVERE, &quot;getUUID for &quot; + obj.getClass()</span>
	                + &quot; takes strange parameter: &quot;,
	                iare);
<span class="nc" id="L206">	        return null;</span>
<span class="nc" id="L207">	    } catch (IllegalAccessException iace) {</span>
	        // Apparently it had a getItemUID,
	        // but we're not allowed to call it
<span class="nc" id="L210">	        return null;</span>
<span class="nc" id="L211">	    } catch (InvocationTargetException tie) {</span>
<span class="nc" id="L212">                LOG.log(Level.SEVERE,</span>
<span class="nc" id="L213">                        &quot;getUUID for &quot; + obj.getClass() + &quot; threw: &quot;,</span>
	                tie);
<span class="nc" id="L215">	        return null;</span>
	    }
<span class="nc" id="L217">	} catch (SecurityException se) {</span>
	    // Apparently it had a getItemUID,
	    // but we're not allowed to call it
<span class="nc" id="L220">	    return null;</span>
<span class="nc" id="L221">	} catch (InvocationTargetException tie) {</span>
<span class="nc" id="L222">            LOG.log(Level.SEVERE,</span>
<span class="nc" id="L223">                    &quot;getItemUID for &quot; + obj.getClass() + &quot; threw: &quot;,</span>
                    tie);
<span class="nc" id="L225">	    return null;</span>
<span class="nc" id="L226">	} catch (IllegalAccessException iace) {</span>
	    // Apparently it had a getItemUID,
	    // but we're not allowed to call it
<span class="nc" id="L229">	    return null;</span>
<span class="nc" id="L230">	} catch (IllegalArgumentException iare) {</span>
<span class="nc" id="L231">            LOG.log(Level.SEVERE,</span>
<span class="nc" id="L232">                    &quot;getItemUID for &quot; + obj.getClass()</span>
                    + &quot; takes strange parameter: &quot;,
                    iare);
<span class="nc" id="L235">	    return null;</span>
<span class="nc" id="L236">	} catch (ExceptionInInitializerError eiie) {</span>
<span class="nc" id="L237">            LOG.log(Level.SEVERE,</span>
<span class="nc" id="L238">                    &quot;getItemUID for &quot; + obj.getClass()</span>
                    + &quot; exception: &quot;,
                    eiie);
<span class="nc" id="L241">	    return null;</span>
<span class="nc" id="L242">	}</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">	if (rv == null) {</span>
<span class="nc" id="L245">	    return null;</span>
	}

<span class="nc bnc" id="L248" title="All 2 branches missed.">	if (!(rv instanceof ItemUID)) {</span>
<span class="nc" id="L249">            LOG.log(Level.SEVERE,</span>
<span class="nc" id="L250">                    &quot;getItemUID for &quot; + obj.getClass()</span>
<span class="nc" id="L251">                    + &quot; returns strange value: &quot; + rv.getClass());</span>
<span class="nc" id="L252">	    return null;</span>
	}

<span class="nc" id="L255">	return rv.toString();</span>
    }

    /**
     * Tries to create a new ID for the object. It uses the reflective
     * properties of java to access a method named setItemUID(ItemUID).
     * If that method exist and doesn't throw when called, then the call
     * is assumed to have been successful and the object is responsible
     * for remembering the ID.
     *
     * @param obj The object to assign a new ID.
     * @return	The new ID of the object, or null.
     */
    protected static String createObjectID(Object obj) {
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">	if (Model.getFacade().isAUMLElement(obj)) {</span>
<span class="nc" id="L270">	    return null;</span>
	}

<span class="pc bpc" id="L273" title="1 of 2 branches missed.">	if (obj instanceof IItemUID) {</span>
<span class="fc" id="L274">	    ItemUID uid = new ItemUID();</span>
<span class="fc" id="L275">	    ((IItemUID) obj).setItemUID(uid);</span>
<span class="fc" id="L276">	    return uid.toString();</span>
	}

<span class="nc" id="L279">	Class[] params = new Class[1];</span>
	Object[] mparam;
<span class="nc" id="L281">	params[0] = MYCLASS;</span>
	try {
            // TODO: We shouldn't need this reflection any more once we have
            // convinced ourselves that everything with a setItemUID method
            // is implementing IItemUID
<span class="nc" id="L286">	    Method m = obj.getClass().getMethod(&quot;setItemUID&quot;, params);</span>
<span class="nc" id="L287">	    mparam = new Object[1];</span>
<span class="nc" id="L288">	    mparam[0] = new ItemUID();</span>
<span class="nc" id="L289">	    m.invoke(obj, mparam);</span>
<span class="nc" id="L290">	} catch (NoSuchMethodException nsme) {</span>
	    // Apparently this object had no setItemUID
<span class="nc" id="L292">	    return null;</span>
<span class="nc" id="L293">	} catch (SecurityException se) {</span>
	    // Apparently it had a setItemUID,
	    // but we're not allowed to call it
<span class="nc" id="L296">	    return null;</span>
<span class="nc" id="L297">	} catch (InvocationTargetException tie) {</span>
<span class="nc" id="L298">            LOG.log(Level.SEVERE,</span>
<span class="nc" id="L299">                    &quot;setItemUID for &quot; + obj.getClass() + &quot; threw&quot;,</span>
                    tie);
<span class="nc" id="L301">	    return null;</span>
<span class="nc" id="L302">	} catch (IllegalAccessException iace) {</span>
	    // Apparently it had a setItemUID,
	    // but we're not allowed to call it
<span class="nc" id="L305">	    return null;</span>
<span class="nc" id="L306">	} catch (IllegalArgumentException iare) {</span>
<span class="nc" id="L307">            LOG.log(Level.SEVERE,</span>
<span class="nc" id="L308">                    &quot;setItemUID for &quot; + obj.getClass()</span>
                    + &quot; takes strange parameter&quot;,
                    iare);
<span class="nc" id="L311">	    return null;</span>
<span class="nc" id="L312">	} catch (ExceptionInInitializerError eiie) {</span>
<span class="nc" id="L313">            LOG.log(Level.SEVERE,</span>
<span class="nc" id="L314">                    &quot;setItemUID for &quot; + obj.getClass() + &quot; threw&quot;,</span>
                    eiie);
<span class="nc" id="L316">	    return null;</span>
<span class="nc" id="L317">	}</span>

<span class="nc" id="L319">	return mparam[0].toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>