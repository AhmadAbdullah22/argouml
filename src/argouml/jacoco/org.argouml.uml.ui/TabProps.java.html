<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TabProps.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">argouml-app</a> &gt; <a href="index.source.html" class="el_package">org.argouml.uml.ui</a> &gt; <span class="el_source">TabProps.java</span></div><h1>TabProps.java</h1><pre class="source lang-java linenums">/* $Id$
 *****************************************************************************
 * Copyright (c) 2009-2012 Contributors - see below
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    bobtarling
 *****************************************************************************
 *
 * Some portions of this file was previously release using the BSD License:
 */

// Copyright (c) 1996-2008 The Regents of the University of California. All
// Rights Reserved. Permission to use, copy, modify, and distribute this
// software and its documentation without fee, and without a written
// agreement is hereby granted, provided that the above copyright notice
// and this paragraph appear in all copies.  This software program and
// documentation are copyrighted by The Regents of the University of
// California. The software program and documentation are supplied &quot;AS
// IS&quot;, without any accompanying services from The Regents. The Regents
// does not warrant that the operation of the program will be
// uninterrupted or error-free. The end-user understands that the program
// was developed for research purposes and is advised not to rely
// exclusively on the program for any reason.  IN NO EVENT SHALL THE
// UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
// SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS,
// ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF
// THE UNIVERSITY OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF
// SUCH DAMAGE. THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
// MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE
// PROVIDED HEREUNDER IS ON AN &quot;AS IS&quot; BASIS, AND THE UNIVERSITY OF
// CALIFORNIA HAS NO OBLIGATIONS TO PROVIDE MAINTENANCE, SUPPORT,
// UPDATES, ENHANCEMENTS, OR MODIFICATIONS.

package org.argouml.uml.ui;

import java.awt.BorderLayout;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.swing.JPanel;
import javax.swing.event.EventListenerList;

import org.argouml.application.api.AbstractArgoJPanel;
import org.argouml.cognitive.Critic;
import org.argouml.model.Model;
import org.argouml.swingext.UpArrowIcon;
import org.argouml.ui.TabModelTarget;
import org.argouml.ui.targetmanager.TargetEvent;
import org.argouml.ui.targetmanager.TargetListener;
import org.argouml.ui.targetmanager.TargetManager;
import org.argouml.uml.diagram.ArgoDiagram;
import org.argouml.uml.diagram.ui.PropPanelString;
import org.tigris.gef.base.Diagram;
import org.tigris.gef.presentation.Fig;
import org.tigris.gef.presentation.FigText;
import org.tigris.swidgets.Horizontal;
import org.tigris.swidgets.Orientable;
import org.tigris.swidgets.Orientation;

/**
 * This is the tab on the details panel (DetailsPane) that holds the property
 * panel. On change of target, the property panel in TabProps is changed.
 * &lt;p&gt;
 * With the introduction of the TargetManager, this class holds its original
 * power of controlling its target. The property panels (subclasses of
 * PropPanel) for which this class is the container are being registered as
 * TargetListeners in the setTarget method of this class. They are not
 * registered with TargetManager but with this class to prevent race-conditions
 * while firing TargetEvents from TargetManager.
 */
public class TabProps
    extends AbstractArgoJPanel
    implements TabModelTarget {

    /**
     * Logger.
     */
<span class="fc" id="L85">    private static final Logger LOG =</span>
<span class="fc" id="L86">        Logger.getLogger(TabProps.class.getName());</span>

<span class="fc" id="L88">    private JPanel blankPanel = new JPanel();</span>
<span class="fc" id="L89">    private Hashtable&lt;Class, JPanel&gt; panels =</span>
        new Hashtable&lt;Class, JPanel&gt;();
    private JPanel lastPanel;
<span class="fc" id="L92">    private String panelClassBaseName = &quot;&quot;;</span>

    /**
     * The panel currently displayed in center
     */
    private JPanel currentPanel;

    private Object target;

    /**
     * The list with targetlisteners, these are the property panels
     * managed by TabProps.
     * It should only contain one listener at a time.
     */
<span class="fc" id="L106">    private EventListenerList listenerList = new EventListenerList();</span>

    /**
     * The constructor.
     *
     */
    public TabProps() {
<span class="fc" id="L113">        this(&quot;tab.properties&quot;, &quot;ui.PropPanel&quot;);</span>
<span class="fc" id="L114">    }</span>

    /**
     * The constructor.
     *
     * @param tabName the name of the tab
     * @param panelClassBase the panel class base
     */
    public TabProps(String tabName, String panelClassBase) {
<span class="fc" id="L123">        super(tabName);</span>
<span class="fc" id="L124">        setIcon(new UpArrowIcon());</span>
        // TODO: This should be managed by the DetailsPane TargetListener - tfm
        // remove the following line
<span class="fc" id="L127">        TargetManager.getInstance().addTargetListener(this);</span>
<span class="fc" id="L128">        setOrientation(Horizontal.getInstance());</span>
<span class="fc" id="L129">        panelClassBaseName = panelClassBase;</span>
<span class="fc" id="L130">        setLayout(new BorderLayout());</span>
<span class="fc" id="L131">    }</span>

    /**
     * Set the orientation of the property panel.
     *
     * @param orientation the new orientation for this property panel
     *
     * @see org.tigris.swidgets.Orientable#setOrientation(org.tigris.swidgets.Orientation)
     */
    @Override
    public void setOrientation(Orientation orientation) {
<span class="fc" id="L142">        super.setOrientation(orientation);</span>
<span class="fc" id="L143">        Enumeration pps = panels.elements();</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        while (pps.hasMoreElements()) {</span>
<span class="nc" id="L145">            Object o = pps.nextElement();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (o instanceof Orientable) {</span>
<span class="nc" id="L147">                Orientable orientable = (Orientable) o;</span>
<span class="nc" id="L148">                orientable.setOrientation(orientation);</span>
            }
<span class="nc" id="L150">        }</span>
<span class="fc" id="L151">    }</span>

    /**
     * Adds a property panel to the internal list. This allows a plugin to
     * add / register a new property panel at run-time.
     * This property panel will then
     * be displayed in the detatils pane whenever an element
     * of the given metaclass is selected.
     *
     * @param clazz the metaclass whose details show be displayed
     *          in the property panel p
     * @param panel an instance of the property panel for the metaclass m
     *
     */
    public void addPanel(Class clazz, PropPanel panel) {
<span class="nc" id="L166">        panels.put(clazz, panel);</span>
<span class="nc" id="L167">    }</span>


    ////////////////////////////////////////////////////////////////
    // accessors
    /**
     * Sets the target of the property panel. The given target t
     * may either be a Diagram or a modelelement. If the target
     * given is a Fig, a check is made if the fig has an owning
     * modelelement and occurs on the current diagram.
     * If so, that modelelement is the target.
     *
     * @deprecated As of ArgoUml version 0.13.5,
     *         the visibility of this method will change in the future,
     *         replaced by {@link org.argouml.ui.targetmanager.TargetManager}.
     *         TODO: MVW: I think this should not be deprecated.
     *
     * @param target the new target
     * @see org.argouml.ui.TabTarget#setTarget(java.lang.Object)
     */
    @Deprecated
    public void setTarget(Object target) {
        // targets ought to be UML objects or diagrams
<span class="fc" id="L190">        LOG.log(Level.INFO, &quot;setTarget: there are {0} targets&quot;,</span>
<span class="fc" id="L191">                TargetManager.getInstance().getTargets().size());</span>

<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        target = (target instanceof Fig) ? ((Fig) target).getOwner() : target;</span>
<span class="pc bpc" id="L194" title="4 of 8 branches missed.">        if (!(target == null || Model.getFacade().isAUMLElement(target)</span>
                || target instanceof ArgoDiagram
                // TODO Improve extensibility of this!
                || target instanceof Critic)) {
<span class="nc" id="L198">            target = null;</span>
        }

<span class="pc bpc" id="L201" title="1 of 2 branches missed.">        if (lastPanel != null) {</span>
<span class="nc" id="L202">            remove(lastPanel);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            if (lastPanel instanceof TargetListener) {</span>
                // TODO: We should assert this never happens before removing
                // panels should control their own listeners
<span class="nc" id="L206">                removeTargetListener((TargetListener) lastPanel);</span>
            }
        }

        // TODO: No need to do anything if we're not visible
//        if (!isVisible()) {
//            return;
//        }

<span class="fc" id="L215">        this.target = target;</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L217">            add(blankPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L218">            validate();</span>
<span class="nc" id="L219">            repaint();</span>
<span class="nc" id="L220">            lastPanel = blankPanel;</span>
        } else {
<span class="fc" id="L222">            JPanel newPanel = findPanelFor(target);</span>
<span class="pc bpc" id="L223" title="1 of 4 branches missed.">            if (newPanel != null &amp;&amp; newPanel instanceof TabModelTarget) {</span>
<span class="fc" id="L224">                addTargetListener((TabModelTarget) newPanel);</span>
            }

<span class="fc bfc" id="L227" title="All 2 branches covered.">            if (currentPanel != null) {</span>
<span class="fc" id="L228">                remove(currentPanel);</span>
<span class="fc" id="L229">                currentPanel = null;</span>
            }
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (newPanel != null) {</span>
<span class="fc" id="L232">                currentPanel = newPanel;</span>
            } else {
<span class="fc" id="L234">                currentPanel = blankPanel;</span>
<span class="fc" id="L235">                lastPanel = blankPanel;</span>
            }
<span class="fc" id="L237">            add(currentPanel);</span>
<span class="fc" id="L238">            validate();</span>
<span class="fc" id="L239">            repaint();</span>
        }
<span class="fc" id="L241">    }</span>

    /*
     * @see org.argouml.ui.TabTarget#refresh()
     */
    public void refresh() {
<span class="nc" id="L247">        setTarget(TargetManager.getInstance().getTarget());</span>
<span class="nc" id="L248">    }</span>

    /**
     * Find the correct properties panel for the target.
     *
     * @param trgt the target class
     * @return the tab panel
     */
    private JPanel findPanelFor(Object trgt) {
        // TODO: No test coverage for this or createPropPanel? - tfm

<span class="fc" id="L259">        JPanel panel = createPropPanel(trgt);</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (panel != null) {</span>
<span class="fc" id="L261">            LOG.log(Level.FINE,</span>
<span class="fc" id="L262">                    &quot;Factory created {0} for {1}&quot;, new Object[]{panel.getClass().getName(), trgt.getClass().getName()});</span>
<span class="fc" id="L263">            panels.put(trgt.getClass(), panel);</span>
<span class="fc" id="L264">            return panel;</span>
        }
<span class="fc" id="L266">        LOG.log(Level.SEVERE, &quot;Failed to create a prop panel for: {0}&quot;, trgt);</span>
<span class="fc" id="L267">        return null;</span>
    }

    /**
     * A factory method to create a PropPanel for a particular target (Diagram,
     * UML Element or GEF Fig).
     *
     * @param targetObject the target object
     * @return A new prop panel to display any model element of the given type
     */
    private JPanel createPropPanel(Object targetObject) {
<span class="fc" id="L278">	JPanel propPanel = null;</span>

	for (PropPanelFactory factory
<span class="fc bfc" id="L281" title="All 2 branches covered.">	        : PropPanelFactoryManager.getFactories()) {</span>
<span class="fc" id="L282">	    propPanel = factory.createPropPanel(targetObject);</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">	    if (propPanel != null) {</span>
<span class="fc" id="L284">	        return propPanel;</span>
	    }
<span class="fc" id="L286">	}</span>

	/* This does not work (anymore/yet?),
	 * since we never have a FigText here: */
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">	if (targetObject instanceof FigText) {</span>
<span class="nc" id="L291">            propPanel = new PropPanelString();</span>
        }

<span class="pc bpc" id="L294" title="1 of 2 branches missed.">        if (propPanel instanceof Orientable) {</span>
<span class="nc" id="L295">            ((Orientable) propPanel).setOrientation(getOrientation());</span>
        }

        // TODO: We shouldn't need this as well as the above.
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">        if (propPanel instanceof PropPanel) {</span>
<span class="nc" id="L300">            ((PropPanel) propPanel).setOrientation(getOrientation());</span>
        }

<span class="fc" id="L303">        return propPanel;</span>
    }

    /**
     * @return the name
     */
    protected String getClassBaseName() {
<span class="nc" id="L310">        return panelClassBaseName;</span>
    }

    /**
     * Returns the current target.
     * @deprecated As of ArgoUml version 0.13.5,
     * the visibility of this method will change in the future, replaced by
     * {@link org.argouml.ui.targetmanager.TargetManager#getTarget()
     * TargetManager.getInstance().getTarget()}.
     * TODO: MVW: I think this should not be deprecated.
     *
     * @return the target
     * @see org.argouml.ui.TabTarget#getTarget()
     */
    @Deprecated
    public Object getTarget() {
<span class="nc" id="L326">        return target;</span>
    }

    /**
     * Determines if the property panel should be enabled.
     * The property panel should always be enabled if the
     * target is an instance of a modelelement or an argodiagram.
     * If the target given is a Fig, a check is made if the fig
     * has an owning modelelement and occurs on
     * the current diagram. If so, that modelelement is the target.
     * @param target the target
     * @return true if property panel should be enabled
     * @see org.argouml.ui.TabTarget#shouldBeEnabled(Object)
     */
    public boolean shouldBeEnabled(Object target) {
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">        if (target instanceof Fig) {</span>
<span class="nc" id="L342">            target = ((Fig) target).getOwner();</span>
        }

        // TODO: this should be more extensible... may be only
        // &quot;findPanelFor(target)&quot; if there is a panel why not show it?
<span class="pc bpc" id="L347" title="2 of 6 branches missed.">        return ((target instanceof Diagram || Model.getFacade().isAUMLElement(</span>
                target)) || target instanceof Critic
<span class="pc bnc" id="L349" title="All 2 branches missed.">                &amp;&amp; findPanelFor(target) != null);</span>
    }

    /*
     * @see org.argouml.ui.targetmanager.TargetListener#targetAdded(org.argouml.ui.targetmanager.TargetEvent)
     */
    public void targetAdded(TargetEvent targetEvent) {
<span class="nc" id="L356">        setTarget(TargetManager.getInstance().getSingleTarget());</span>
<span class="nc" id="L357">        fireTargetAdded(targetEvent);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (listenerList.getListenerCount() &gt; 0) {</span>
<span class="nc" id="L359">            validate();</span>
<span class="nc" id="L360">            repaint();</span>
        }

<span class="nc" id="L363">    }</span>

    /*
     * @see org.argouml.ui.targetmanager.TargetListener#targetRemoved(org.argouml.ui.targetmanager.TargetEvent)
     */
    public void targetRemoved(TargetEvent targetEvent) {
<span class="nc" id="L369">        setTarget(TargetManager.getInstance().getSingleTarget());</span>
<span class="nc" id="L370">        fireTargetRemoved(targetEvent);</span>
<span class="nc" id="L371">        validate();</span>
<span class="nc" id="L372">        repaint();</span>
<span class="nc" id="L373">    }</span>

    /*
     * @see org.argouml.ui.targetmanager.TargetListener#targetSet(org.argouml.ui.targetmanager.TargetEvent)
     */
    public void targetSet(TargetEvent targetEvent) {
<span class="fc" id="L379">        setTarget(TargetManager.getInstance().getSingleTarget());</span>
<span class="fc" id="L380">        fireTargetSet(targetEvent);</span>
<span class="fc" id="L381">        validate();</span>
<span class="fc" id="L382">        repaint();</span>
<span class="fc" id="L383">    }</span>

    /**
     * Adds a listener.
     * @param listener the listener to add
     */
    private void addTargetListener(TargetListener listener) {
<span class="fc" id="L390">        listenerList.add(TargetListener.class, listener);</span>
<span class="fc" id="L391">    }</span>

    /**
     * Removes a target listener.
     * @param listener the listener to remove
     */
    private void removeTargetListener(TargetListener listener) {
<span class="nc" id="L398">        listenerList.remove(TargetListener.class, listener);</span>
<span class="nc" id="L399">    }</span>

    private void fireTargetSet(TargetEvent targetEvent) {
        //      Guaranteed to return a non-null array
<span class="fc" id="L403">        Object[] listeners = listenerList.getListenerList();</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">        for (int i = listeners.length - 2; i &gt;= 0; i -= 2) {</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">            if (listeners[i] == TargetListener.class) {</span>
                // Lazily create the event:
<span class="fc" id="L407">		((TargetListener) listeners[i + 1]).targetSet(targetEvent);</span>
            }
        }
<span class="fc" id="L410">    }</span>

    private void fireTargetAdded(TargetEvent targetEvent) {
        // Guaranteed to return a non-null array
<span class="nc" id="L414">        Object[] listeners = listenerList.getListenerList();</span>

<span class="nc bnc" id="L416" title="All 2 branches missed.">        for (int i = listeners.length - 2; i &gt;= 0; i -= 2) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">            if (listeners[i] == TargetListener.class) {</span>
                // Lazily create the event:
<span class="nc" id="L419">		((TargetListener) listeners[i + 1]).targetAdded(targetEvent);</span>
            }
        }
<span class="nc" id="L422">    }</span>

    private void fireTargetRemoved(TargetEvent targetEvent) {
        // Guaranteed to return a non-null array
<span class="nc" id="L426">        Object[] listeners = listenerList.getListenerList();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        for (int i = listeners.length - 2; i &gt;= 0; i -= 2) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (listeners[i] == TargetListener.class) {</span>
                // Lazily create the event:
<span class="nc" id="L430">                ((TargetListener) listeners[i + 1]).targetRemoved(targetEvent);</span>
            }
        }
<span class="nc" id="L433">    }</span>
} /* end class TabProps */
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>