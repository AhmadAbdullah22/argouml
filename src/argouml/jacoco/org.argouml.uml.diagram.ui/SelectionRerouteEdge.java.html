<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SelectionRerouteEdge.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">argouml-app</a> &gt; <a href="index.source.html" class="el_package">org.argouml.uml.diagram.ui</a> &gt; <span class="el_source">SelectionRerouteEdge.java</span></div><h1>SelectionRerouteEdge.java</h1><pre class="source lang-java linenums">/* $Id$
 *****************************************************************************
 * Copyright (c) 2009-2012 Contributors - see below
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    bobtarling
 *****************************************************************************
 *
 * Some portions of this file was previously release using the BSD License:
 */

// Copyright (c) 1996-2007 The Regents of the University of California. All
// Rights Reserved. Permission to use, copy, modify, and distribute this
// software and its documentation without fee, and without a written
// agreement is hereby granted, provided that the above copyright notice
// and this paragraph appear in all copies.  This software program and
// documentation are copyrighted by The Regents of the University of
// California. The software program and documentation are supplied &quot;AS
// IS&quot;, without any accompanying services from The Regents. The Regents
// does not warrant that the operation of the program will be
// uninterrupted or error-free. The end-user understands that the program
// was developed for research purposes and is advised not to rely
// exclusively on the program for any reason.  IN NO EVENT SHALL THE
// UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
// SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS,
// ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF
// THE UNIVERSITY OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF
// SUCH DAMAGE. THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
// MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE
// PROVIDED HEREUNDER IS ON AN &quot;AS IS&quot; BASIS, AND THE UNIVERSITY OF
// CALIFORNIA HAS NO OBLIGATIONS TO PROVIDE MAINTENANCE, SUPPORT,
// UPDATES, ENHANCEMENTS, OR MODIFICATIONS.

package org.argouml.uml.diagram.ui;

import java.awt.Rectangle;
import java.awt.event.MouseEvent;
import java.util.Enumeration;

import org.argouml.uml.diagram.UMLMutableGraphSupport;
import org.tigris.gef.base.Editor;
import org.tigris.gef.base.FigModifyingMode;
import org.tigris.gef.base.Globals;
import org.tigris.gef.base.Layer;
import org.tigris.gef.base.LayerManager;
import org.tigris.gef.base.ModeCreatePolyEdge;
import org.tigris.gef.base.ModeManager;
import org.tigris.gef.presentation.Fig;
import org.tigris.gef.presentation.FigEdge;
import org.tigris.gef.presentation.FigNode;

/**
 * A general class for rerouting edges, achieved by delegating
 * the re-routing logic to the graphmodels; extends
 * functionality in SelectionEdgeClarifiers.
 *
 * &lt;p&gt;If a graphmodel does not override canChangeConnectedNode()
 * then rerouting is not possible and ArgoUML should behave as if
 * rerouting had never been implemented.
 *
 * @author  alexb
 * @since 0.13.2
 */
public class SelectionRerouteEdge extends SelectionEdgeClarifiers {

    /**
     * Used to determine if the association is now to self,
     * in which case The association needs automatic layout.
     */
    private FigNode sourceFig;

    /**
     * Used to determine if the association is now to self,
     * in which case The association needs automatic layout.
     */
    private FigNode destFig;

    /**
     * The re-routing capability it armed if the mouse was previously
     * dragged.
     * &lt;p&gt;prevents just selecting the message then clicking somewhere
     * else on the diagram,
     */
    private boolean armed;

    /**
     * The index of the point on the line of the message.
     * &lt;p&gt;0 = sender end
     * &lt;p&gt;1..* = receiver end
     */
    private int pointIndex;

    /** 
     * Creates a new instance of SelectionRerouteEdge
     *
     * @param feme the given Fig
     */
    public SelectionRerouteEdge(FigEdgeModelElement feme) {
        // TODO: There is a cyclic dependency between SelectionRerouteEdge
        // and FigEdgeModelElement
<span class="nc" id="L106">        super(feme);</span>

        // set it to an invalid number by default
        // to make sure it is set correctly.
<span class="nc" id="L110">        pointIndex = -1;</span>
<span class="nc" id="L111">    }</span>

    /**
     * Set up for re-routing.
     *
     * {@inheritDoc}
     */
    public void mousePressed(MouseEvent me) {

        // calculate the source and dest figs for to self assoc
<span class="nc" id="L121">        sourceFig =</span>
<span class="nc" id="L122">	    ((FigEdge) getContent()).getSourceFigNode();</span>
<span class="nc" id="L123">        destFig = </span>
<span class="nc" id="L124">            ((FigEdge) getContent()).getDestFigNode();</span>

<span class="nc" id="L126">        final Rectangle mousePosition =</span>
<span class="nc" id="L127">	    new Rectangle(me.getX() - 5, me.getY() - 5, 10, 10);</span>
        //reset the pointIndex
<span class="nc" id="L129">        pointIndex = -1;</span>
<span class="nc" id="L130">        final int npoints = getContent().getNumPoints();</span>
<span class="nc" id="L131">        final int[] xs = getContent().getXs();</span>
<span class="nc" id="L132">        final int[] ys = getContent().getYs();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (mousePosition.contains(xs[0], ys[0])) {</span>
<span class="nc" id="L134">            pointIndex = 0;</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        } else if (mousePosition.contains(</span>
                xs[npoints - 1], ys[npoints - 1])) {
<span class="nc" id="L137">            pointIndex = npoints - 1;</span>
        }

<span class="nc" id="L140">        super.mousePressed(me);</span>
<span class="nc" id="L141">    }</span>

    /*
     * Need to 'arm' the rerouting capability with mouseDragged().
     * &lt;p&gt;
     * Don't arm if the edtior's current mode is a figedge create mode,
     * because once a new edge has been created it is not deselected,
     * therefore on the next create an unwanted reroute is performed.
     *
     * @see java.awt.event.MouseMotionListener#mouseDragged(java.awt.event.MouseEvent)
     */
    public void mouseDragged(MouseEvent me) {

<span class="nc" id="L154">        Editor editor = Globals.curEditor();</span>
<span class="nc" id="L155">        ModeManager modeMgr = editor.getModeManager();</span>
<span class="nc" id="L156">        FigModifyingMode fMode = modeMgr.top();</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (!(fMode instanceof ModeCreatePolyEdge)) {</span>
<span class="nc" id="L159">            armed = true;</span>
        }
<span class="nc" id="L161">        super.mouseDragged(me);</span>
<span class="nc" id="L162">    }</span>

    /*
     * Perform re-routing if src/dest nodes have changed.
     *
     * &lt;p&gt;This method needs to be 'armed' by a previous mouseDragged()
     * to avoid the situation where the user just clicks on the node
     * then clicks on some unrelated Fig, without moving the edge...
     *
     * &lt;p&gt;TODO: improve the fig finding algorithm to find the top most fig
     * in the layer. will be useful for nested states in a statechart.
     *
     * @see java.awt.event.MouseListener#mouseReleased(java.awt.event.MouseEvent)
     */
    public void mouseReleased(MouseEvent me) {
        // check pre-conds
<span class="nc bnc" id="L178" title="All 6 branches missed.">        if (me.isConsumed() || !armed || pointIndex == -1) {</span>
<span class="nc" id="L179">            armed = false;</span>
<span class="nc" id="L180">            super.mouseReleased(me);</span>
<span class="nc" id="L181">            return;</span>
        }

        //Set-up:
<span class="nc" id="L185">        int x = me.getX(), y = me.getY();</span>
        // the fig that was under the mouse when it was released
<span class="nc" id="L187">        FigNodeModelElement newFig = null;</span>
        //make a nice little target area:
<span class="nc" id="L189">        Rectangle mousePoint = new Rectangle(x - 5, y - 5, 5, 5);</span>
        // and find the Fig:
<span class="nc" id="L191">        Editor editor = Globals.curEditor();</span>
<span class="nc" id="L192">        LayerManager lm = editor.getLayerManager();</span>
<span class="nc" id="L193">        Layer active = lm.getActiveLayer();</span>
<span class="nc" id="L194">        Enumeration figs = active.elementsIn(mousePoint);</span>
        // last is the top fig.
<span class="nc bnc" id="L196" title="All 2 branches missed.">        while (figs.hasMoreElements()) {</span>
<span class="nc" id="L197">            Fig candidateFig = (Fig) figs.nextElement();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            if (candidateFig instanceof FigNodeModelElement</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                    &amp;&amp; candidateFig.isSelectable()) {</span>
<span class="nc" id="L200">                newFig = (FigNodeModelElement) candidateFig;</span>
            }
<span class="nc" id="L202">        }</span>
        // check intermediate post-condition.
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (newFig == null) {</span>
<span class="nc" id="L205">            armed = false;</span>
<span class="nc" id="L206">            super.mouseReleased(me);</span>
<span class="nc" id="L207">            return;</span>
        }

<span class="nc" id="L210">        UMLMutableGraphSupport mgm =</span>
<span class="nc" id="L211">            (UMLMutableGraphSupport) editor.getGraphModel();</span>
<span class="nc" id="L212">        FigNode oldFig = null;</span>
<span class="nc" id="L213">        boolean isSource = false;</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (pointIndex == 0) {</span>
<span class="nc" id="L215">            oldFig = sourceFig;</span>
<span class="nc" id="L216">            isSource = true;</span>
        }
        else {
<span class="nc" id="L219">            oldFig = destFig;</span>
        }

        // delegate the re-routing to graphmodels.
<span class="nc bnc" id="L223" title="All 2 branches missed.">        if (mgm.canChangeConnectedNode(newFig.getOwner(),</span>
<span class="nc" id="L224">				       oldFig.getOwner(),</span>
<span class="nc" id="L225">				       this.getContent().getOwner())) {</span>
<span class="nc" id="L226">	    mgm.changeConnectedNode(newFig.getOwner(),</span>
<span class="nc" id="L227">				    oldFig.getOwner(),</span>
<span class="nc" id="L228">				    this.getContent().getOwner(),</span>
				    isSource);
	}

<span class="nc" id="L232">        editor.getSelectionManager().deselect(getContent());</span>
<span class="nc" id="L233">        armed = false;</span>
        // TODO: There is a cyclic dependency between SelectionRerouteEdge
        // and FigEdgeModelElement
<span class="nc" id="L236">        FigEdgeModelElement figEdge = (FigEdgeModelElement) getContent();</span>
<span class="nc" id="L237">        figEdge.determineFigNodes();</span>
<span class="nc" id="L238">        figEdge.computeRoute();</span>
<span class="nc" id="L239">        super.mouseReleased(me);</span>
<span class="nc" id="L240">        return;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>