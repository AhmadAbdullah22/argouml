<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FigMessage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">argouml-app</a> &gt; <a href="index.source.html" class="el_package">org.argouml.uml.diagram.ui</a> &gt; <span class="el_source">FigMessage.java</span></div><h1>FigMessage.java</h1><pre class="source lang-java linenums">/* $Id$
 *****************************************************************************
 * Copyright (c) 2009-2010 Contributors - see below
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    mvw
 *    Linus Tolke
 *****************************************************************************
 *
 * Some portions of this file was previously release using the BSD License:
 */

// Copyright (c) 1996-2009 The Regents of the University of California. All
// Rights Reserved. Permission to use, copy, modify, and distribute this
// software and its documentation without fee, and without a written
// agreement is hereby granted, provided that the above copyright notice
// and this paragraph appear in all copies.  This software program and
// documentation are copyrighted by The Regents of the University of
// California. The software program and documentation are supplied &quot;AS
// IS&quot;, without any accompanying services from The Regents. The Regents
// does not warrant that the operation of the program will be
// uninterrupted or error-free. The end-user understands that the program
// was developed for research purposes and is advised not to rely
// exclusively on the program for any reason.  IN NO EVENT SHALL THE
// UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY FOR DIRECT, INDIRECT,
// SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING LOST PROFITS,
// ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF
// THE UNIVERSITY OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF
// SUCH DAMAGE. THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
// MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE
// PROVIDED HEREUNDER IS ON AN &quot;AS IS&quot; BASIS, AND THE UNIVERSITY OF
// CALIFORNIA HAS NO OBLIGATIONS TO PROVIDE MAINTENANCE, SUPPORT,
// UPDATES, ENHANCEMENTS, OR MODIFICATIONS.

package org.argouml.uml.diagram.ui;

import java.awt.Color;
import java.awt.Dimension;
import java.awt.Polygon;
import java.awt.Rectangle;
import java.beans.PropertyChangeEvent;
import java.util.Iterator;
import java.util.Vector;

import org.argouml.model.Model;
import org.argouml.notation.NotationProviderFactory2;
import org.argouml.uml.diagram.DiagramSettings;
import org.argouml.uml.diagram.collaboration.ui.FigAssociationRole;
import org.tigris.gef.base.Layer;
import org.tigris.gef.presentation.Fig;
import org.tigris.gef.presentation.FigPoly;
import org.tigris.gef.presentation.FigText;

/** 
 * Class to display graphics for a UML Message 
 * above an AssociationRole in a collaborations diagram.
 *
 * @author agauthie
 */
public class FigMessage extends FigNodeModelElement {

    private static Vector&lt;String&gt; arrowDirections;

    private static final int SOUTH = 0;
    private static final int EAST = 1;
    private static final int WEST = 2;
    private static final int NORTH = 3;

    static {
<span class="fc" id="L75">        arrowDirections = new Vector&lt;String&gt;(4);</span>
        // TODO: i18n
<span class="fc" id="L77">        arrowDirections.add(SOUTH, &quot;South&quot;);</span>
<span class="fc" id="L78">        arrowDirections.add(EAST, &quot;East&quot;);</span>
<span class="fc" id="L79">        arrowDirections.add(WEST, &quot;West&quot;);</span>
<span class="fc" id="L80">        arrowDirections.add(NORTH, &quot;North&quot;);</span>
<span class="fc" id="L81">    }</span>

    private FigPoly figPoly;

    /**
     * The current arrow direction set to constants above.
     */
<span class="fc" id="L88">    private int arrowDirection = -1;</span>

    private void initFigs() {
<span class="fc" id="L91">        setShadowSize(0); // Issue 2714.</span>
<span class="fc" id="L92">	getNameFig().setLineWidth(0);</span>
<span class="fc" id="L93">	getNameFig().setReturnAction(FigText.END_EDITING);</span>
<span class="fc" id="L94">	getNameFig().setFilled(false);</span>
<span class="fc" id="L95">	Dimension nameMin = getNameFig().getMinimumSize();</span>
<span class="fc" id="L96">	getNameFig().setBounds(X0, Y0, 90, nameMin.height);</span>
<span class="fc" id="L97">        getBigPort().setBounds(X0, Y0, 90, nameMin.height);</span>

<span class="fc" id="L99">	figPoly = new FigPoly(LINE_COLOR, SOLID_FILL_COLOR);</span>
<span class="fc" id="L100">	int[] xpoints = {75, 75, 77, 75, 73, 75};</span>
<span class="fc" id="L101">	int[] ypoints = {33, 24, 24, 15, 24, 24};</span>
<span class="fc" id="L102">	Polygon polygon = new Polygon(xpoints, ypoints, 6);</span>
<span class="fc" id="L103">	figPoly.setPolygon(polygon);</span>
<span class="fc" id="L104">	figPoly.setBounds(100, 10, 5, 18);</span>

<span class="fc" id="L106">        getBigPort().setFilled(false);</span>
<span class="fc" id="L107">        getBigPort().setLineWidth(0);</span>
	// add Figs to the FigNode in back-to-front order
<span class="fc" id="L109">        addFig(getBigPort());</span>
<span class="fc" id="L110">	addFig(getNameFig());</span>
<span class="fc" id="L111">	addFig(figPoly);</span>
<span class="fc" id="L112">    }</span>

    /**
     * Construct a FigMessage.
     * 
     * @param owner owning UML element
     * @param bounds position and size
     * @param settings render settings
     */
    public FigMessage(Object owner, Rectangle bounds, 
            DiagramSettings settings) {
<span class="fc" id="L123">        super(owner, bounds, settings);</span>
<span class="fc" id="L124">        initFigs();</span>
<span class="fc" id="L125">        updateNameText();</span>
<span class="fc" id="L126">    }</span>
    
    /*
     * @see org.argouml.uml.diagram.ui.FigNodeModelElement#getNotationProviderType()
     */
    @Override
    protected int getNotationProviderType() {
<span class="fc" id="L133">        return NotationProviderFactory2.TYPE_MESSAGE;</span>
    }

    /*
     * @see org.argouml.uml.diagram.ui.FigNodeModelElement#updateListeners(
     * java.lang.Object, java.lang.Object)
     */
    @Override
    protected void updateListeners(Object oldOwner, Object newOwner) {
<span class="nc bnc" id="L142" title="All 2 branches missed.">        if (oldOwner != null) {</span>
<span class="nc" id="L143">            removeElementListener(oldOwner);</span>
        }
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (newOwner != null) {</span>
<span class="nc" id="L146">            addElementListener(newOwner, &quot;remove&quot;);</span>
        }
<span class="nc" id="L148">    }</span>


    @Override
    public Object clone() {
<span class="nc" id="L153">	FigMessage figClone = (FigMessage) super.clone();</span>
<span class="nc" id="L154">	Iterator it = figClone.getFigs().iterator();</span>
<span class="nc" id="L155">	figClone.setNameFig((FigText) it.next());</span>
<span class="nc" id="L156">	figClone.figPoly = (FigPoly) it.next();</span>
	//figClone._polygon = (Polygon) _polygon.clone();
<span class="nc" id="L158">	return figClone;</span>
    }

    /*
     * @see org.tigris.gef.presentation.Fig#setLineColor(java.awt.Color)
     */
    @Override
    public void setLineColor(Color col) {
<span class="fc" id="L166">	figPoly.setLineColor(col);</span>
<span class="fc" id="L167">	getNameFig().setLineColor(col);</span>
<span class="fc" id="L168">    }</span>

    /*
     * @see org.tigris.gef.presentation.Fig#getLineColor()
     */
    @Override
    public Color getLineColor() {
<span class="nc" id="L175">        return figPoly.getLineColor();</span>
    }

    /*
     * @see org.tigris.gef.presentation.Fig#setFillColor(java.awt.Color)
     */
    @Override
    public void setFillColor(Color col) {
	//figPoly.setFillColor(col);
<span class="fc" id="L184">	getNameFig().setFillColor(col);</span>
<span class="fc" id="L185">    }</span>
    
    /*
     * @see org.tigris.gef.presentation.Fig#getFillColor()
     */
    @Override
    public Color getFillColor() {
<span class="nc" id="L192">        return getNameFig().getFillColor();</span>
    }

    /*
     * @see org.tigris.gef.presentation.Fig#setFilled(boolean)
     */
    @Override
    public void setFilled(boolean f) {
<span class="fc" id="L200">    }</span>


    @Override
    public boolean isFilled() {
<span class="nc" id="L205">        return true;</span>
    }

    /*
     * @see org.tigris.gef.presentation.Fig#setLineWidth(int)
     */
    @Override
    public void setLineWidth(int w) {
<span class="fc" id="L213">        figPoly.setLineWidth(w);</span>
<span class="fc" id="L214">    }</span>

    /*
     * @see org.tigris.gef.presentation.Fig#getLineWidth()
     */
    @Override
    public int getLineWidth() {
<span class="nc" id="L221">        return figPoly.getLineWidth();</span>
    }

    /**
     * @param direction for the arrow
     * FigMessage.SOUTH
     * FigMessage.EAST
     * FigMessage.WEST
     * FigMessage.NORTH
     */
    public void setArrow(int direction) {
<span class="fc" id="L232">	Rectangle bbox = getBounds();</span>

<span class="fc bfc" id="L234" title="All 2 branches covered.">	if (arrowDirection == direction) {</span>
<span class="fc" id="L235">	    return;</span>
	}

<span class="fc" id="L238">	arrowDirection = direction;</span>
<span class="pc bpc" id="L239" title="2 of 4 branches missed.">	switch (direction) {</span>
        case SOUTH: {
<span class="nc" id="L241">            int[] xpoints = {75, 75, 77, 75, 73, 75};</span>
<span class="nc" id="L242">            int[] ypoints = {15, 24, 24, 33, 24, 24};</span>
<span class="nc" id="L243">            Polygon polygon = new Polygon(xpoints, ypoints, 6);</span>
<span class="nc" id="L244">            figPoly.setPolygon(polygon);</span>
<span class="nc" id="L245">            break;</span>
        }
        case EAST: {
<span class="fc" id="L248">            int[] xpoints = {66, 75, 75, 84, 75, 75};</span>
<span class="fc" id="L249">            int[] ypoints = {24, 24, 26, 24, 22, 24};</span>
<span class="fc" id="L250">            Polygon polygon = new Polygon(xpoints, ypoints, 6);</span>
<span class="fc" id="L251">            figPoly.setPolygon(polygon);</span>
<span class="fc" id="L252">            break;</span>
        }
        case WEST: {
<span class="fc" id="L255">            int[] xpoints = {84, 75, 75, 66, 75, 75};</span>
<span class="fc" id="L256">            int[] ypoints = {24, 24, 26, 24, 22, 24};</span>
<span class="fc" id="L257">            Polygon polygon = new Polygon(xpoints, ypoints, 6);</span>
<span class="fc" id="L258">            figPoly.setPolygon(polygon);</span>
<span class="fc" id="L259">            break;</span>
        }
        default: { // north
<span class="nc" id="L262">            int[] xpoints = {75, 75, 77, 75, 73, 75};</span>
<span class="nc" id="L263">            int[] ypoints = {33, 24, 24, 15, 24, 24};</span>
<span class="nc" id="L264">            Polygon polygon = new Polygon(xpoints, ypoints, 6);</span>
<span class="nc" id="L265">            figPoly.setPolygon(polygon);</span>
<span class="nc" id="L266">            break;</span>
        }
        }
<span class="fc" id="L269">	setBounds(bbox);</span>
<span class="fc" id="L270">    }</span>

    /**
     * @return the arrow direction
     */
<span class="nc" id="L275">    public int getArrow() { return arrowDirection; }</span>

    /*
     * @see org.tigris.gef.presentation.Fig#getMinimumSize()
     */
    @Override
    public Dimension getMinimumSize() {
<span class="fc" id="L282">	Dimension nameMin = getNameFig().getMinimumSize();</span>
<span class="fc" id="L283">	Dimension figPolyMin = figPoly.getSize();</span>

<span class="fc" id="L285">	int h = Math.max(figPolyMin.height, nameMin.height);</span>
<span class="fc" id="L286">	int w = figPolyMin.width + nameMin.width;</span>
<span class="fc" id="L287">	return new Dimension(w, h);</span>
    }

    /*
     * Override setBounds to keep shapes looking right.
     * @see org.tigris.gef.presentation.Fig#setBounds(int, int, int, int)
     */
    @Override
    protected void setStandardBounds(int x, int y, int w, int h) {
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">        if (getNameFig() == null) {</span>
<span class="nc" id="L297">            return;</span>
        }

<span class="fc" id="L300">        Rectangle oldBounds = getBounds();</span>

<span class="fc" id="L302">        Dimension nameMin = getNameFig().getMinimumSize();</span>

<span class="fc" id="L304">        int ht = 0;</span>

<span class="pc bpc" id="L306" title="1 of 2 branches missed.">        if (nameMin.height &gt; figPoly.getHeight()) {</span>
<span class="fc" id="L307">            ht = (nameMin.height - figPoly.getHeight()) / 2;</span>
        }
        
<span class="fc" id="L310">        getNameFig().setBounds(x, y, w - figPoly.getWidth(), nameMin.height);</span>
<span class="fc" id="L311">        getBigPort().setBounds(x, y, w - figPoly.getWidth(), nameMin.height);</span>
<span class="fc" id="L312">        figPoly.setBounds(x + getNameFig().getWidth(), y + ht,</span>
<span class="fc" id="L313">        		   figPoly.getWidth(), figPoly.getHeight());</span>

<span class="fc" id="L315">        firePropChange(&quot;bounds&quot;, oldBounds, getBounds());</span>
<span class="fc" id="L316">        calcBounds(); //_x = x; _y = y; _w = w; _h = h;</span>
<span class="fc" id="L317">        updateEdges();</span>
<span class="fc" id="L318">    }</span>
    
    
    /*
     * TODO: The code implementing this method is from 2003 (see issue 2171) -
     * mechanically integrated by tfmorris in May 2007. Needs to be
     * reviewed/updated.
     * 
     * @author Decki,Endi,Yayan, Politechnic of Bandung. Computer Departement
     * method for changing text of Message
     */
    @Override
    protected void modelChanged(PropertyChangeEvent mee) {
<span class="nc" id="L331">        super.modelChanged(mee);</span>
        
        // Do nothing until code is reviewed
        if (true) {
<span class="nc" id="L335">            return;</span>
        }
        
        if (Model.getFacade().isAMessage(getOwner())) {
            if (Model.getFacade().isAParameter(mee.getSource())) {
                Object par = mee.getSource();
                updateArgumentsFromParameter(getOwner(), par);

            }
            
            if (mee == null || mee.getSource() == getOwner()
                    || Model.getFacade().isAAction(mee.getSource())
                    || Model.getFacade().isAOperation(mee.getSource())
                    || Model.getFacade().isAArgument(mee.getSource())
                    || Model.getFacade().isASignal(mee.getSource())) {
                updateListeners(getOwner());
            }

            // needs to be updated for changes in Notation subsystem - tfm
//            String nameStr = Notation.generate(this, getOwner()).trim();
//            getNameFig().setText(nameStr);
            updateArrow();
            damage();
        }
    }


    /**
     * TODO: The code implementing this method is from 2003 (see issue 2171) -
     * mechanically integrated by tfmorris in May 2007. Needs to be
     * reviewed/updated.
     * 
     * @author Decki,Endi,Yayan, Politechnic of Bandung. Computer Departement
     * method for changing text of Message
     * @param newOwner
     * @param parameter
     */
    protected void updateArgumentsFromParameter(Object newOwner,
            Object parameter) {

        // Do nothing until code is reviewed
        if (true) {
<span class="nc" id="L377">            return;</span>
        }
        
        if (newOwner != null) {
            Object act = Model.getFacade().getAction(newOwner);
            if (Model.getFacade().isACallAction(act)) {
                if (Model.getFacade().getOperation(act) != null) {
                    Object operation = Model.getFacade().getOperation(act);
                    if (Model.getDirectionKind().getInParameter().equals(
                            Model.getFacade().getKind(parameter))) {
                        
                        // Update for changes in Model subsystem - tfm
//                        Collection colpar = Model.getFacade().getInParameters(
//                                operation);
//                        Collection colarg = Model.getFacade()
//                                .getActualArguments(act);
//                        if (colpar.size() == colarg.size()) {
//                            Iterator iter = colarg.iterator();
//                            while (iter.hasNext()) {
//                                Object arg = iter.next();
//                                if (!iter.hasNext()) {
//                                    Model.getCommonBehaviorHelper()
//                                            .removeActualArgument(act, arg);
//                                }
//                            }
//                        }
                        Object newArgument = Model.getCommonBehaviorFactory()
                                .createArgument();
                        Model.getCommonBehaviorHelper().setValue(
                                newArgument,
                                Model.getDataTypesFactory().createExpression(
                                        &quot;&quot;,
                                        Model.getFacade().getName(parameter)));
                        Model.getCoreHelper().setName(newArgument,
                                Model.getFacade().getName(parameter));
                        Model.getCommonBehaviorHelper().addActualArgument(act,
                                newArgument);

                        Model.getPump().removeModelEventListener(this,
                                parameter);
                        Model.getPump().addModelEventListener(this, parameter);
                    }
                }
            }
        }
    }


    /**
     * TODO: The code implementing this method is from 2003 (see issue 2171) -
     * mechanically integrated by tfmorris in May 2007. Needs to be
     * reviewed/updated.
     * 
     * @author Decki,Endi,Yayan, Politechnic of Bandung. Computer Departement
     * method for changing text of Message
     * @param newOwner model element which should now be listened to
     */
    protected void updateListeners(Object newOwner) {
        // Our superclass no longer has this method, so perhaps this whole
        // thing should be removed? - tfm 
//        super.updateListeners(newOwner);
        
        // TODO: Do nothing until code is reviewed
        if (true) {
<span class="nc" id="L441">            return;</span>
        }
        
        if (newOwner != null) {
            Object act = Model.getFacade().getAction(newOwner);
            if (act != null) {
                Model.getPump().removeModelEventListener(this, act);
                Model.getPump().addModelEventListener(this, act);
                Iterator iter = Model.getFacade().getActualArguments(act)
                        .iterator();
                while (iter.hasNext()) {
                    Object arg = iter.next();
                    Model.getPump().removeModelEventListener(this, arg);
                    Model.getPump().addModelEventListener(this, arg);
                }
                if (Model.getFacade().isACallAction(act)) {
                    Object oper = Model.getFacade().getOperation(act);
                    if (oper != null) {
                        Model.getPump().removeModelEventListener(this, oper);
                        Model.getPump().addModelEventListener(this, oper);
                        Iterator it2 = Model.getFacade().getParameters(oper)
                                .iterator();
                        while (it2.hasNext()) {
                            Object param = it2.next();
                            Model.getPump().removeModelEventListener(this,
                                    param);
                            Model.getPump().addModelEventListener(this, param);
                        }
                    }
                }
                if (Model.getFacade().isASendAction(act)) {
                    Object sig = Model.getFacade().getSignal(act);
                    if (sig != null) {
                        Model.getPump().removeModelEventListener(this, sig);
                    }
                    Model.getPump().addModelEventListener(this, sig);
                }
            }
        }
    }


    /**
     * Determines the direction of the message arrow. Determination of the type
     * of arrow happens in modelChanged.
     */
    public void updateArrow() {
<span class="fc" id="L488">  	Object mes = getOwner(); // Message</span>
<span class="pc bpc" id="L489" title="2 of 4 branches missed.">	if (mes == null || getLayer() == null) {</span>
<span class="nc" id="L490">	    return;</span>
	}
<span class="fc" id="L492">	Object sender = Model.getFacade().getSender(mes); // ClassifierRole</span>
<span class="fc" id="L493">	Object receiver = Model.getFacade().getReceiver(mes); // ClassifierRole</span>
<span class="fc" id="L494">	Fig senderPort = getLayer().presentationFor(sender);</span>
<span class="fc" id="L495">	Fig receiverPort = getLayer().presentationFor(receiver);</span>
<span class="pc bpc" id="L496" title="2 of 4 branches missed.">	if (senderPort == null || receiverPort == null) {</span>
<span class="nc" id="L497">	    return;</span>
	}
<span class="fc" id="L499">	int sx = senderPort.getX();</span>
<span class="fc" id="L500">	int sy = senderPort.getY();</span>
<span class="fc" id="L501">	int rx = receiverPort.getX();</span>
<span class="fc" id="L502">	int ry = receiverPort.getY();</span>
<span class="pc bpc" id="L503" title="1 of 4 branches missed.">	if (sx &lt; rx &amp;&amp; Math.abs(sy - ry) &lt;= Math.abs(sx - rx)) { // east</span>
<span class="fc" id="L504">	    setArrow(EAST);</span>
<span class="pc bpc" id="L505" title="2 of 4 branches missed.">	} else if (sx &gt; rx &amp;&amp; Math.abs(sy - ry) &lt;= Math.abs(sx - rx)) { // west</span>
<span class="fc" id="L506">	    setArrow(WEST);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">	} else if (sy &lt; ry) { // south</span>
<span class="nc" id="L508">	    setArrow(SOUTH);</span>
	} else {
<span class="nc" id="L510">	    setArrow(NORTH);</span>
	}
<span class="fc" id="L512">    }</span>

    /**
     * Add the FigMessage to the Path Items of its FigAssociationRole.
     * 
     * @param lay the Layer
     */
    public void addPathItemToFigAssociationRole(Layer lay) {
	Object associationRole =
<span class="fc" id="L521">	    Model.getFacade().getCommunicationConnection(getOwner());</span>
<span class="pc bpc" id="L522" title="2 of 4 branches missed.">	if (associationRole != null &amp;&amp; lay != null) {</span>
<span class="fc" id="L523">	    FigAssociationRole figAssocRole =</span>
<span class="fc" id="L524">		(FigAssociationRole) lay.presentationFor(associationRole);</span>
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">	    if (figAssocRole != null) {</span>
<span class="fc" id="L526">		figAssocRole.addMessage(this);</span>
<span class="fc" id="L527">		lay.bringToFront(this);</span>
	    }
	}
<span class="fc" id="L530">    }</span>

    /*
     * @see org.argouml.uml.diagram.ui.FigNodeModelElement#renderingChanged()
     */
    @Override
    public void renderingChanged() {
<span class="nc" id="L537">        super.renderingChanged();</span>
<span class="nc" id="L538">        updateArrow();</span>
<span class="nc" id="L539">    }</span>

    /**
     * @return Returns the arrowDirections.
     */
    public static Vector&lt;String&gt; getArrowDirections() {
<span class="nc" id="L545">        return arrowDirections;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>